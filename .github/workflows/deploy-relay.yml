name: Deploy Relay

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-relay-production
  cancel-in-progress: false

jobs:
  deploy-relay:
    name: Build and Deploy darkwire-relay
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      REMOTE_BIN: /opt/darkwire/bin/darkwire-relay
      REMOTE_TMP: /opt/darkwire/bin/darkwire-relay.next

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies and target
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target

      - name: Validate deployment secrets
        shell: bash
        run: |
          set -euo pipefail
          test -n "$VPS_HOST"
          test -n "$VPS_USER"
          test -n "${{ secrets.VPS_SSH_KEY_B64 }}"

      - name: Normalize SSH target values
        shell: bash
        run: |
          set -euo pipefail
          clean_host="$(printf '%s' "$VPS_HOST" | tr -d '\r\n')"
          clean_user="$(printf '%s' "$VPS_USER" | tr -d '\r\n')"
          test -n "$clean_host"
          test -n "$clean_user"
          echo "VPS_HOST=$clean_host" >> "$GITHUB_ENV"
          echo "VPS_USER=$clean_user" >> "$GITHUB_ENV"

      - name: Build darkwire-relay (release)
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --locked -p darkwire-relay --bin darkwire-relay

      - name: Setup SSH
        env:
          VPS_SSH_KEY_B64: ${{ secrets.VPS_SSH_KEY_B64 }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "$VPS_SSH_KEY_B64" | tr -d '\r\n' | base64 --decode > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          : > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          keyscan_ok=false
          for attempt in 1 2 3; do
            if ssh-keyscan -T 5 -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null; then
              keyscan_ok=true
              break
            fi
            echo "::warning::ssh-keyscan failed on attempt ${attempt}, retrying..."
            sleep 2
          done

          if [[ "$keyscan_ok" != "true" ]]; then
            echo "::error::ssh-keyscan failed after 3 attempts for host $VPS_HOST"
            exit 1
          fi

          if ! test -s ~/.ssh/known_hosts; then
            echo "::error::known_hosts is empty after ssh-keyscan for host $VPS_HOST"
            exit 1
          fi

          ssh-keygen -lf ~/.ssh/id_ed25519

      - name: Verify SSH connectivity and deploy path
        shell: bash
        run: |
          set -euo pipefail
          ssh \
            -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            "${VPS_USER}@${VPS_HOST}" \
            "echo ssh_ok=yes && test -d '${REMOTE_BIN%/*}'" || {
              echo "::error::SSH verification failed. Check VPS_HOST, VPS_USER, VPS_SSH_KEY_B64 and that deploy key is in ~/.ssh/authorized_keys."
              exit 1
            }

      - name: Upload relay binary
        shell: bash
        run: |
          set -euo pipefail
          test -f target/release/darkwire-relay
          ls -lh target/release/darkwire-relay

          if scp \
            -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            target/release/darkwire-relay \
            "${VPS_USER}@${VPS_HOST}:${REMOTE_TMP}"; then
            echo "upload_method=scp"
          else
            echo "::warning::SCP upload failed, retrying via SSH stream copy to ${REMOTE_TMP}."
            ssh \
              -i ~/.ssh/id_ed25519 \
              -o IdentitiesOnly=yes \
              -o StrictHostKeyChecking=yes \
              -o BatchMode=yes \
              -o ConnectTimeout=15 \
              "${VPS_USER}@${VPS_HOST}" \
              "cat > '${REMOTE_TMP}'" < target/release/darkwire-relay
            echo "upload_method=ssh_stream"
          fi

          ssh \
            -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            "${VPS_USER}@${VPS_HOST}" \
            "test -s '${REMOTE_TMP}' && ls -lh '${REMOTE_TMP}'"

      - name: Restart darkwire-relay service
        shell: bash
        run: |
          set -euo pipefail
          ssh \
            -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            "${VPS_USER}@${VPS_HOST}" \
            "chmod +x '${REMOTE_TMP}' && mv -f '${REMOTE_TMP}' '${REMOTE_BIN}' && sudo /bin/chmod +x '${REMOTE_BIN}' && sudo /usr/bin/systemctl restart darkwire-relay && sudo /usr/bin/systemctl status darkwire-relay --no-pager"
